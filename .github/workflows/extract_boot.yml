name: Xiaomi Boot Extractor (Release Version)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM URL'
        required: true
      model_name:
        description: 'æœºå‹åç§°'
        required: true
      rom_version:
        description: 'ç‰ˆæœ¬å·'
        required: true

jobs:
  extract_and_upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸš€ æå–å¹¶é‡å‘½å
        run: |
          mkdir -p output
          # æå–æ–‡ä»¶
          curl -L "${{ github.event.inputs.rom_url }}" | tar -zxvf - \
            --wildcards '*/boot.img' '*/init_boot.img' \
            --transform='s|.*/||' \
            -C output || echo "Missing files"

          # æ ¼å¼åŒ–åç§°ï¼šå°†ç©ºæ ¼è½¬ä¸ºä¸‹åˆ’çº¿
          SAFE_MODEL=$(echo "${{ github.event.inputs.model_name }}" | sed 's/ /_/g')
          SAFE_VERSION=$(echo "${{ github.event.inputs.rom_version }}" | sed 's/ /_/g')

          # æ ¸å¿ƒæ”¹åŠ¨ï¼šé‡å‘½åæ–‡ä»¶ä¸º "æœºå‹__ç‰ˆæœ¬__æ–‡ä»¶å.img"
          # ä¾‹å¦‚ï¼šXiaomi_12__V14.0.1__boot.img
          cd output
          for f in *.img; do
            if [ -f "$f" ]; then
              new_name="${SAFE_MODEL}__${SAFE_VERSION}__${f}"
              mv "$f" "$new_name"
              echo "[*] Prepared: $new_name"
            fi
          done

      - name: ğŸ“¤ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware_storage
          files: output/*.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
