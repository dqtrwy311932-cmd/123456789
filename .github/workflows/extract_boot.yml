name: Xiaomi Boot Extractor (Git Push)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM URL'
        required: true
      model_name:
        description: 'æœºå‹åç§°'
        required: true
      rom_version:
        description: 'ç‰ˆæœ¬å·'
        required: true

jobs:
  extract_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸš€ ç²¾å‡†æå–é•œåƒ
        run: |
          # 1. å‡†å¤‡ç›®å½•
          SAFE_MODEL=$(echo "${{ github.event.inputs.model_name }}" | sed 's/ /_/g')
          SAFE_VERSION=$(echo "${{ github.event.inputs.rom_version }}" | sed 's/ /_/g')
          TARGET_DIR="firmware/${SAFE_MODEL}/${SAFE_VERSION}"
          mkdir -p "$TARGET_DIR"

          echo "[*] æ­£åœ¨æå–..."
          # 2. æå–å¹¶å¼ºåˆ¶å¹³é“ºåˆ°ç›®æ ‡ç›®å½•
          curl -L "${{ github.event.inputs.rom_url }}" | tar -zxvf - \
            --wildcards '*/boot.img' '*/init_boot.img' \
            --transform='s|.*/||' \
            -C "$TARGET_DIR" || echo "éƒ¨åˆ†æ–‡ä»¶ç¼ºå¤±"

      - name: ğŸ“¤ å¼ºåˆ¶æ¨é€åŒæ­¥
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 3. å…³é”®æ”¹è¿›ï¼šæ·»åŠ æ‰€æœ‰æ›´æ”¹ï¼ˆåŒ…å«å›ºä»¶ç›®å½•å’Œä»»ä½•æ„å¤–å‡ºç°åœ¨æ ¹ç›®å½•çš„æ–‡ä»¶ï¼‰
          git add .
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Add: ${{ github.event.inputs.model_name }} ($SAFE_VERSION)"
            git push origin main --force
          else
            echo "æ²¡æœ‰æ–‡ä»¶å¯æäº¤"
          fi
