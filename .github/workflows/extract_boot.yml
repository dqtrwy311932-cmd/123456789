name: Xiaomi Boot Extractor (Streaming)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM URL'
        required: true
      model_name:
        description: 'æœºå‹åç§°'
        required: true
      rom_version:
        description: 'ç‰ˆæœ¬å·'
        required: true

jobs:
  extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸš€ æµå¼æå–é•œåƒ
        run: |
          mkdir -p output
          mkdir -p temp_run
          echo "[*] å¼€å§‹æµå¼æ‰«æ: ${{ github.event.inputs.rom_url }}"
          
          # 1. ç®¡é“æå–åˆ° temp_run ç›®å½•
          curl -L "${{ github.event.inputs.rom_url }}" | tar -zxvf - \
            --wildcards '*boot.img' \
            -C temp_run/ || echo "[!] ç®¡é“ä¼ è¾“ç»“æŸ"

          # 2. æ·±åº¦æœç´¢ï¼šå°†æ‰€æœ‰ img ç§»åŠ¨åˆ° output æ ¹ç›®å½•
          find temp_run/ -name "*.img" -exec mv {} output/ \;

          # 3. é‡å‘½åå¹¶æ¸…ç†
          SAFE_MODEL=$(echo "${{ github.event.inputs.model_name }}" | sed 's/ /_/g')
          SAFE_VERSION=$(echo "${{ github.event.inputs.rom_version }}" | sed 's/ /_/g')
          
          cd output
          if [ -n "$(ls -A .)" ]; then
            echo "[âœ“] æˆåŠŸæå–æ–‡ä»¶åˆ—è¡¨:"
            for f in *.img; do
              # æ’é™¤æ‰ vendor_boot ç­‰ä¸æƒ³è¦çš„æ–‡ä»¶ï¼ˆå¦‚æœä½ åªéœ€è¦ boot å’Œ init_bootï¼‰
              if [[ "$f" == *"vendor_boot"* ]]; then
                 rm "$f"
                 continue
              fi
              mv "$f" "${SAFE_MODEL}__${SAFE_VERSION}__${f}"
              ls -lh "${SAFE_MODEL}__${SAFE_VERSION}__${f}"
            done
          else
            echo "[!] é”™è¯¯ï¼šæœªåœ¨æå–ç›®å½•ä¸­å‘ç°æœ‰æ•ˆçš„ img æ–‡ä»¶"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware_storage
          files: output/*.img
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
