name: Xiaomi Boot Extractor (Streaming)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM URL'
        required: true
      model_name:
        description: 'æœºå‹åç§°'
        required: true
      rom_version:
        description: 'ç‰ˆæœ¬å·'
        required: true

jobs:
  extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸš€ æµå¼æå–é•œåƒ
        run: |
          mkdir -p output
          echo "[*] å¼€å§‹æµå¼æ‰«æ ROM: ${{ github.event.inputs.rom_url }}"
          
          # ä½¿ç”¨ curl ä¸‹è½½å¹¶ç›´æ¥é€šè¿‡ç®¡é“ä¼ è¾“ç»™ tar
          # --wildcards ç”¨äºåŒ¹é…æ–‡ä»¶å
          # --transform='s|.*/||' ç§»é™¤æ‰€æœ‰å‰ç½®è·¯å¾„ï¼Œç›´æ¥æ”¾è¿› output
          # --ignore-command-error é˜²æ­¢å› ä¸ºéƒ¨åˆ†æ–‡ä»¶æœªæ‰¾åˆ°è€Œä¸­æ–­
          curl -L "${{ github.event.inputs.rom_url }}" | tar -zxvf - \
            --wildcards '*boot.img' \
            --transform='s|.*/||' \
            -C output/ || echo "[!] ç®¡é“æå–ç»“æŸ (éƒ¨åˆ†æ–‡ä»¶å¯èƒ½å·²æ•è·)"

          # æ£€æŸ¥æå–ç»“æœ
          SAFE_MODEL=$(echo "${{ github.event.inputs.model_name }}" | sed 's/ /_/g')
          SAFE_VERSION=$(echo "${{ github.event.inputs.rom_version }}" | sed 's/ /_/g')
          
          cd output
          if [ -n "$(ls -A .)" ]; then
            echo "[âœ“] æˆåŠŸæå–ä»¥ä¸‹æ–‡ä»¶:"
            for f in *.img; do
              mv "$f" "${SAFE_MODEL}__${SAFE_VERSION}__${f}"
              ls -lh "${SAFE_MODEL}__${SAFE_VERSION}__${f}"
            done
          else
            echo "[!] é”™è¯¯ï¼šæµå¼æœç´¢æœªå‘ç° boot.img æˆ– init_boot.img"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware_storage
          files: output/*.img
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
