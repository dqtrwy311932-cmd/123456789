name: Xiaomi Boot Extractor (Git Push)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM URL'
        required: true
      model_name:
        description: 'æœºå‹åç§°'
        required: true
      rom_version:
        description: 'ç‰ˆæœ¬å·'
        required: true

jobs:
  extract_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸš€ ç²¾å‡†æå–é•œåƒ
        run: |
          # 1. å¤„ç†ä¿å­˜è·¯å¾„ï¼Œé˜²æ­¢ç©ºæ ¼å¯¼è‡´æŠ¥é”™
          SAFE_MODEL=$(echo "${{ github.event.inputs.model_name }}" | sed 's/ /_/g')
          SAFE_VERSION=$(echo "${{ github.event.inputs.rom_version }}" | sed 's/ /_/g')
          TARGET_DIR="firmware/${SAFE_MODEL}/${SAFE_VERSION}"
          mkdir -p "$TARGET_DIR"

          echo "[*] æ­£åœ¨ä» ROM æå– boot å’Œ init_boot..."
          
          # 2. æ ¸å¿ƒï¼šåªè§£å‹ boot.img å’Œ init_boot.img
          # ä½¿ç”¨ --wildcards åŒ¹é…æ‰€æœ‰å­ç›®å½•ä¸‹çš„åŒåæ–‡ä»¶
          # ä½¿ç”¨ --transform å°†è§£å‹å‡ºçš„æ–‡ä»¶ç›´æ¥æ‹å¹³æ”¾å…¥ç›®æ ‡ç›®å½•ï¼Œä¸ä¿ç•™åŸ ROM è·¯å¾„
          curl -L "${{ github.event.inputs.rom_url }}" | tar -zxvf - \
            --wildcards '*/boot.img' '*/init_boot.img' \
            --transform='s|.*/||' \
            -C "$TARGET_DIR" || echo "æç¤ºï¼šéƒ¨åˆ†æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ init_bootï¼‰åœ¨å½“å‰ ROM ä¸­ä¸å­˜åœ¨"

      - name: ğŸ“¤ å¼ºåˆ¶æ¨é€åˆ°ä»“åº“
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # åªæ·»åŠ  firmware ç›®å½•ï¼Œä¿æŒæ ¹ç›®å½•æ•´æ´
          git add firmware/
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Add: ${{ github.event.inputs.model_name }} ($SAFE_VERSION)"
            # ä½¿ç”¨ --force ç¡®ä¿å¹¶å‘ä»»åŠ¡ä¸ä¼šå› ä¸ºæäº¤å†å²å†²çªè€Œå¤±è´¥
            git push origin main --force
          else
            echo "æ²¡æœ‰æå–åˆ°ä»»ä½•æ–°æ–‡ä»¶ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
