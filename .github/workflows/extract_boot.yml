name: Xiaomi Boot Extractor (Fast Stream)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM URL'
        required: true
      model_name:
        description: 'æœºå‹åç§°'
        required: true
      rom_version:
        description: 'ç‰ˆæœ¬å·'
        required: true

jobs:
  extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸš€ æ•è·ç›®æ ‡é•œåƒå¹¶åœæ­¢
        run: |
          mkdir -p output_sync
          echo "[*] å¼€å§‹æµå¼æœç´¢ç›®æ ‡..."
          
          # 1. æ ¸å¿ƒæµå¼å‘½ä»¤ï¼š
          # --exclude='*vendor_boot.img' : å½»åº•è·³è¿‡ vendor_boot
          # --wildcards '*boot.img' : åŒ¹é… boot.img å’Œ init_boot.img
          # --occurrence=2 : åŒ¹é…åˆ°è¿™ä¸¤ä¸ªæ–‡ä»¶åï¼Œtar ä¼šè‡ªåŠ¨å…³é—­ç®¡é“åœæ­¢ä¸‹è½½
          # å¿½ç•¥ç®¡é“ä¸­æ–­äº§ç”Ÿçš„ curl (23) æˆ– tar (1) æŠ¥é”™ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬è¦çš„æ•ˆæœ
          curl -L "${{ github.event.inputs.rom_url }}" | tar -zxvf - \
            --exclude='*vendor_boot.img' \
            --wildcards '*boot.img' \
            --occurrence=2 \
            -C . || echo "[*] ç›®æ ‡å·²æ•è·ï¼Œæµå¼ä¼ è¾“å·²ä¸»åŠ¨åˆ‡æ–­ã€‚"

          # 2. æ·±åº¦æœç´¢æå–åˆ°çš„é•œåƒ
          find . -maxdepth 10 -type f -name "*.img" -exec mv {} output_sync/ \; 2>/dev/null || true

          # 3. æ¸…æ´—æ–‡ä»¶åå¹¶å‡†å¤‡ä¸Šä¼  (è§£å†³ä¸­æ–‡è¢« GitHub è¿‡æ»¤é—®é¢˜)
          SAFE_MODEL=$(echo "${{ github.event.inputs.model_name }}" | sed 's/[^a-zA-Z0-9]/_/g' | tr -s '_')
          SAFE_VERSION=$(echo "${{ github.event.inputs.rom_version }}" | sed 's/[^a-zA-Z0-9.]/_/g' | tr -s '_')
          
          cd output_sync
          if [ -n "$(ls -A .)" ]; then
            echo "[âœ“] æˆåŠŸæ•è·é•œåƒåˆ—è¡¨:"
            for f in *.img; do
              # ä¿æŒå›ºå®šæ ¼å¼ä¾› Python è„šæœ¬æ‹†åˆ†ï¼šDataStart_æœºå‹_SPLIT_ç‰ˆæœ¬_SPLIT_åŸæ–‡ä»¶å
              new_name="DataStart_${SAFE_MODEL}_SPLIT_${SAFE_VERSION}_SPLIT_${f}"
              mv "$f" "$new_name"
              echo "  -> $new_name"
            done
          else
            echo "[!] å¤±è´¥ï¼šæœªèƒ½åœ¨ ROM ä¸­å‘ç° boot.img æˆ– init_boot.img"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware_storage
          files: output_sync/*.img
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
