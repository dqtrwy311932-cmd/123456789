name: Xiaomi Boot Extractor (Release Version)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM URL'
        required: true
      model_name:
        description: 'æœºå‹åç§°'
        required: true
      rom_version:
        description: 'ç‰ˆæœ¬å·'
        required: true

jobs:
  extract_and_upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸš€ æå–é•œåƒ
        run: |
          mkdir -p output
          mkdir -p temp_extract
          echo "[*] æ­£åœ¨ä¸‹è½½å¹¶è§£å‹ ROM..."
          
          # 1. ä¸‹è½½å¹¶è§£å‹æ‰€æœ‰åŒ…å« boot çš„ img
          curl -L "${{ github.event.inputs.rom_url }}" | tar -zxvf - \
            --wildcards '*boot.img' \
            -C temp_extract || echo "æå–ç»“æŸ"

          # 2. å¼ºåˆ¶æœç´¢æ‰€æœ‰å±‚çº§ï¼Œç§»åŠ¨åˆ° output ç›®å½•
          # è¿™ä¸€æ­¥ä¿è¯äº†æ— è®º ROM è·¯å¾„å¤šæ·±ï¼Œéƒ½èƒ½æŠ“åˆ°æ–‡ä»¶
          find temp_extract -name "*.img" -exec mv {} output/ \;

          # 3. é‡å‘½åå¹¶æ¸…ç†
          SAFE_MODEL=$(echo "${{ github.event.inputs.model_name }}" | sed 's/ /_/g')
          SAFE_VERSION=$(echo "${{ github.event.inputs.rom_version }}" | sed 's/ /_/g')
          
          cd output
          if [ -n "$(ls -A .)" ]; then
            for f in *.img; do
              mv "$f" "${SAFE_MODEL}__${SAFE_VERSION}__${f}"
            done
            echo "[*] æå–æˆåŠŸï¼Œå‡†å¤‡ä¸Šä¼ "
          else
            echo "[!] é”™è¯¯ï¼šæœªå‘ç°ä»»ä½• img æ–‡ä»¶"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware_storage
          files: output/*.img
          # å³ä½¿ tag å­˜åœ¨ä¹Ÿæ›´æ–°å†…å®¹
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
