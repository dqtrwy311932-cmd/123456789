name: Xiaomi Boot Extractor (Test Mode)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM URL'
        required: true
      model_name:
        description: 'æ©Ÿå‹åç¨±'
        required: true
      rom_version:
        description: 'ç‰ˆæœ¬è™Ÿ'
        required: true

jobs:
  extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸš€ æ¸¬è©¦æµå¼æå– (é¦–å€‹åŒ¹é…å³åœæ­¢)
        run: |
          mkdir -p output_test
          echo "[*] é–‹å§‹æ¸¬è©¦æµå¼æƒæ: ${{ github.event.inputs.rom_url }}"
          
          # 1. ä½¿ç”¨ --occurrence=1 æ‰¾åˆ°ç¬¬ä¸€å€‹ç¬¦åˆ *boot.img çš„æ–‡ä»¶å°±åœæ­¢
          # ä½¿ç”¨ --ignore-command-error å¿½ç•¥å› ç‚ºç®¡é“æå‰é—œé–‰å°è‡´çš„ curl å ±éŒ¯
          curl -L "${{ github.event.inputs.rom_url }}" | tar -zxvf - \
            --wildcards '*boot.img' \
            --occurrence=1 \
            || echo "[*] å·²æ•ç²é¦–å€‹ç›®æ¨™ï¼Œç®¡é“å·²ä¸­æ–· (é€™æ˜¯é æœŸè¡Œç‚º)"

          # 2. æš´åŠ›æœç´¢ç•¶å‰ç›®éŒ„ï¼Œå°‡æŠ“åˆ°çš„æ–‡ä»¶ç§»å…¥ output_test
          echo "[*] æ­£åœ¨æª¢ç´¢æ•ç²çš„æ–‡ä»¶..."
          find . -type f -name "*.img" -exec mv {} output_test/ \;

          # 3. è™•ç†èˆ‡å‘½å
          SAFE_MODEL=$(echo "${{ github.event.inputs.model_name }}" | sed 's/ /_/g')
          SAFE_VERSION=$(echo "${{ github.event.inputs.rom_version }}" | sed 's/ /_/g')
          
          cd output_test
          if [ -n "$(ls -A .)" ]; then
            echo "[âœ“] æ¸¬è©¦æˆåŠŸï¼å·²æ•ç²æ–‡ä»¶:"
            for f in *.img; do
              new_name="${SAFE_MODEL}__${SAFE_VERSION}__${f}"
              mv "$f" "$new_name"
              ls -lh "$new_name"
            done
          else
            echo "[!] å¤±æ•—ï¼šæœªèƒ½åœ¨æµå¼æƒæä¸­æ•ç²ä»»ä½•é¡åƒ"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šå‚³åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware_storage
          files: output_test/*.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
